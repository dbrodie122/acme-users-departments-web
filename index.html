<html>
  <head>
<style>
</style>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js'></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/react-router-dom/5.0.0/react-router-dom.js'></script>
  </head>
  <body>
    <div id='root'></div>
    <script type='text/babel'>
      const { HashRouter, Route, Link } = ReactRouterDOM;
      class CreateForm extends React.Component{
        constructor(props){
          super(props);
          this.state = {
            name: '',
            entity: 'department' 
          };
          this.onChange = this.onChange.bind(this);
          this.onCreate = this.onCreate.bind(this);
          /*
          this.onCancel = this.onCancel.bind(this);
          this.onDestroy = this.onDestroy.bind(this);
          */
        }
        onCreate(ev){
          ev.preventDefault();
          console.log(this.props.match ? this.props.match.id : '', this.state.entity, this.state.name, this.props.history);
        }
        onChange(ev){
          this.setState({ [ev.target.name]: ev.target.value });
        }
        render(){
          const { entity, name } = this.state;
          const { onChange, onCreate } = this;
          return (
            <form onSubmit={ onCreate }>
              <div>
                Department
                <input type='radio' checked={ entity === 'department'} name='entity' value='department' onChange={ onChange }/>
              </div>
              <div>
                User
                <input type='radio' name='entity' value='user' checked={ entity === 'user' } onChange={ onChange }/>
              </div>
              <input />
              <button>Create { entity }</button>
            </form>
          );
        }
      }
      class Department extends React.Component{
        constructor(props){
          super(props);
          this.state = {
            name: this.props.department.name
          };
          this.onSave = this.onSave.bind(this);
          this.onChange = this.onChange.bind(this);
          this.onCancel = this.onCancel.bind(this);
          this.onDestroy = this.onDestroy.bind(this);
        }
        onDestroy(ev){
          ev.stopPropagation();
          this.props.onDestroy();
        }
        onCancel(ev){
          ev.stopPropagation();
          this.setState({ name: this.props.department.name });
        }
        onChange(ev){
          this.setState({ [ev.target.name] : ev.target.value });
        }
        onSave(ev){
          ev.preventDefault();
          this.props.onUpdate({...this.props.department, name: this.state.name});
          
        }
        componentDidUpdate(prevProps){
          if(prevProps.selectedId !== this.props.selectedId){
            this.setState({ name: this.props.department.name });
          }
        }
        render(){
          const { department, selected, users } = this.props;
          const { name } = this.state;
          const { onSave, onChange, onCancel, onDestroy } = this;
          const count = users.filter(user => user.departmentId === department.id).length;
          if(!selected){
            return (
                <div>
                  <Link to={`/${department.id}`}>{ department.name }( { count } )</Link>
                </div>
            );
          }
          else {
            return (
                <form onSubmit={ onSave }>
                  <input value={ name } onChange={ onChange } name='name'/> ({ count })
                  <button disabled={ this.props.department.name === name }>Save</button>
                  <button onClick={ onCancel } disabled={ this.props.department.name === name }>Cancel</button>
                  <button onClick={ onDestroy }>Destroy</button>
                </form>
            );
          }
        }
      }

      const Users = ()=> {
        return null;
      };

      const Departments = ({ departments, users, match, onUpdate, onDestroy, history})=> {
        const count = users.filter( user => !user.departmentId).length;
        return (
          <div>
            <Link to='/'>No Department ({ count })</Link>
            {
              departments.map( department => <Department selected={ match.params.id*1 === department.id } key={ department.id} department={ department } users = { users } selectedId={ match.params ? match.params.id : ''} onUpdate={ onUpdate } onDestroy={()=> onDestroy(department, history) }/>)
            }
          </div>
        );
      };
      class App extends React.Component{
        constructor(){
          super();
          this.state = {
            URL: localStorage.getItem('URL') || '',
            users: [],
            departments: [],
            error: ''
          };
          this.onChange = this.onChange.bind(this);
          this.setURL = this.setURL.bind(this);
          this.onUpdateDepartment = this.onUpdateDepartment.bind(this);
          this.onDestroyDepartment = this.onDestroyDepartment.bind(this);
          this.loadData = this.loadData.bind(this);
          this.onCreate = this.onCreate.bind(this);
        }
        async onCreate(id, entity, name){
          console.log(id, entity, name);
        }
        async onDestroyDepartment(department, history){
          const updated = await axios.delete(`${this.state.URL}/api/departments/${department.id}`);
          this.loadData();
          history.push('/');
        }
        async onUpdateDepartment(department){
          const updated = await axios.put(`${this.state.URL}/api/departments/${department.id}`, department);
          this.loadData();
        }
        setURL(ev){
          ev.preventDefault();
          localStorage.setItem('URL', this.state.URL);
        }
        onChange(ev){
          this.setState({[ev.target.name]: ev.target.value});
        }
        componentDidMount(){
          this.loadData();
        }
        async loadData(){
          try{
             const [ userResponse, departmentsResponse ] = await Promise.all([
              axios.get(`${this.state.URL}/api/users`),
              axios.get(`${this.state.URL}/api/departments`)
            ]);
            this.setState({ users: userResponse.data, departments: departmentsResponse.data });
          }
          catch(ex){
            console.log(ex);
            this.setState({ error: ex.message });
          }
        }
        render(){
          const { onChange, setURL, onUpdateDepartment, onDestroyDepartment, onCreate } = this;
          const { URL, error, users, departments } = this.state;
          
          return (
            <HashRouter>
              <div>
                { !!error && <div>{ error }</div>}
                <form onSubmit={ setURL }>
                  <input name='URL' onChange={ onChange } value={ URL }/>
                  <button>Save</button>
                </form>
                { users.length }
                <Route path=':id?' render={ ({ match, history })=> <CreateForm match={ match } history={ history } onCreate={ onCreate }/> } />
                <Route
                  path='/:id?'
            render={({ match, history })=> <Departments match={ match } departments={ departments } users = { users } onUpdate={ onUpdateDepartment } onDestroy={ onDestroyDepartment } history={ history }/> }/>
                <Route
                  path='/:id?'
                  render={({ match })=> <Users match={ match } departments={ departments } users = { users } /> } />
              </div>
            </HashRouter>
          );
        }
      }
      const root = document.querySelector('#root');
      ReactDOM.render(<App />, root);
    </script>
  </body>
</html>
